<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>うどんこねるゲーム</title>
  <link rel="icon" href="favicon.ico">
<style>
  :root { --bg:#fffaf3; --ink:#2b2b2b; --accent:#ffb703; --accent2:#8ecae6; --good:#2a9d8f; --warn:#e76f51; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP","Noto Sans CJK JP",sans-serif}
  header{padding:14px 16px;border-bottom:1px dashed #00000020;background:#fff;position:sticky;top:0;z-index:2}
  h1{margin:0;font-size:20px}
  .wrap{max-width:900px;margin:0 auto;padding:14px}
  .stats{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .badge{padding:6px 10px;border-radius:999px;background:#00000008}
  .timer{font-variant-numeric:tabular-nums}
  .bar{height:14px;background:#00000010;border-radius:999px;overflow:hidden;box-shadow:inset 0 0 0 1px #00000010}
  .bar > div{height:100%;width:0}
  .bar .play{background:linear-gradient(90deg,var(--accent2),#90ee90)}
  .bar .knead{background:linear-gradient(90deg,var(--accent),#ffd166)}
  .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:10px;border:1px solid #00000020;background:#fff;cursor:pointer}
  button.primary{background:var(--good);color:#fff;border:none}
  button.warn{background:var(--warn);color:#fff;border:none}
  canvas{background:radial-gradient(circle at 50% 40%, #fff 0%, #fff 40%, #fff8 60%, #0000 61%), #f7eddc; border-radius:18px; box-shadow: inset 0 10px 30px #00000010, 0 8px 24px #00000010; touch-action:none}
  .lock{padding:14px;border:2px dashed #00000020;border-radius:12px;background:#ffffffb8;backdrop-filter:saturate(120%) blur(2px)}
  footer{opacity:.7;text-align:center;padding:18px 0}
  .small{font-size:12px}
</style>
</head>
<body>
<header>
  <h1>うどんこねるゲーム（1日1時間）</h1>
</header>

<div class="wrap">
  <section class="stats" aria-live="polite">
    <div class="badge">今日の残り時間：<span id="timeLeft" class="timer">--:--:--</span></div>
    <div class="badge">今日の日付（JST）：<span id="jstDate">--</span></div>
    <div class="badge">通算うどん玉：<span id="bowlCount">0</span> 玉</div>
  </section>

  <hr />

  <section>
    <div class="row" style="margin:10px 0 6px">
      <div>こね進捗</div>
      <div class="bar" aria-label="こね進捗">
        <div id="kneadBar" class="knead" style="width:0%"></div>
      </div>
    </div>
    <div class="row" style="margin:6px 0 18px">
      <div>今日のプレイ</div>
      <div class="bar" aria-label="今日のプレイ時間">
        <div id="playBar" class="play" style="width:0%"></div>
      </div>
    </div>

    <div class="controls">
      <button id="resetKnead" title="今の生地を捨ててやり直し">生地を捨てる</button>
      <button id="howTo">遊び方</button>
      <button id="wipe" class="warn" title="セーブ全部削除（制限も消えます）">セーブ削除</button>
    </div>
  </section>

  <section style="margin:16px 0">
    <div style="position:relative">
      <canvas id="stage" width="900" height="520" aria-label="うどん生地キャンバス"></canvas>
      <div id="lock" class="lock" style="display:none; position:absolute; inset:12px; display:flex; align-items:center; justify-content:center; text-align:center">
        <div>
          <h2>本日の持ち時間は終了！</h2>
          <p class="timer">次の解禁（JST 0:00）まで <span id="untilReset">--:--:--</span></p>
          <p class="small">※この制限は端末ごとです。会社の端末でのプレイはおすすめしません🍜</p>
        </div>
      </div>
    </div>
  </section>

  <footer class="small">© あなたのローカルで完結。BGMなし・効果音なし（静かにこねたい方向け）。</footer>
</div>

<script>
(function(){
  // ---- 設定 ----
  const DAILY_LIMIT_SEC = 60 * 60; // 1時間
  const JST_OFFSET_MS = 9 * 60 * 60 * 1000; // UTC+9 固定（JSTはDSTなし）

  const TAP_DELAY_MS = 120; // クリック後の待ち時間（ms）//タッププニの時間

  // ---- 保存キー ----
  const KEY = {
    usedSec: 'udon_used_seconds',
    jstDate: 'udon_date_jst',
    lastStamp: 'udon_last_epoch_ms',
    bowls: 'udon_total_bowls'
  };

  // ---- ユーティリティ：JSTの今 ----
  function nowJST(){ return new Date(Date.now() + JST_OFFSET_MS); }
  function todayJstStr(){
    const d = nowJST();
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,'0');
    const day = String(d.getUTCDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function secondsUntilNextJstMidnight(){
    const now = nowJST();
    const next = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()+1, 0,0,0));
    return Math.max(0, Math.floor((next - now) / 1000));
  }
  function fmtHMS(sec){
    const s = Math.max(0, Math.floor(sec));
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  }

  // ---- 状態 ----
  let usedSec = Number(localStorage.getItem(KEY.usedSec) || 0);
  let savedDate = localStorage.getItem(KEY.jstDate) || todayJstStr();
  let lastStamp = Number(localStorage.getItem(KEY.lastStamp) || Date.now());
  let bowlCount = Number(localStorage.getItem(KEY.bowls) || 0);

  // 日付が変わっていたらリセット
  function dailyRolloverCheck(){
    const today = todayJstStr();
    if(savedDate !== today){
      usedSec = 0;
      savedDate = today;
      localStorage.setItem(KEY.usedSec, usedSec);
      localStorage.setItem(KEY.jstDate, savedDate);
    }
  }
  dailyRolloverCheck();

  // 実時間差分で使用時間を加算
function accruePlaytime(){
  dailyRolloverCheck();
  const now = Date.now();

  if (isLocked()) {               // ロック中は印だけ更新
    lastStamp = now;
    localStorage.setItem(KEY.lastStamp, lastStamp);
    return;
  }

  const elapsedMs = now - lastStamp;
  if (elapsedMs >= 1000) {
    const delta = Math.floor(elapsedMs / 1000); // 経過「整数秒」
    usedSec = Math.min(DAILY_LIMIT_SEC, usedSec + delta);
    lastStamp += delta * 1000;    // 端数msを次回に繰り越す（←ここが大事）
    localStorage.setItem(KEY.usedSec, usedSec);
    localStorage.setItem(KEY.lastStamp, lastStamp);
  }
}


  function isLocked(){ return usedSec >= DAILY_LIMIT_SEC; }

  // ---- UI参照 ----
  const elTimeLeft = document.getElementById('timeLeft');
  const elJstDate  = document.getElementById('jstDate');
  const elBowl     = document.getElementById('bowlCount');
  const elKneadBar = document.getElementById('kneadBar');
  const elPlayBar  = document.getElementById('playBar');
  const elLock     = document.getElementById('lock');
  const elUntil    = document.getElementById('untilReset');
  const btnReset   = document.getElementById('resetKnead');
  const btnHowTo   = document.getElementById('howTo');
  const btnWipe    = document.getElementById('wipe');
  const canvas     = document.getElementById('stage');
  const ctx = canvas.getContext('2d');

  let tapTimeout = null; // クリック遅延タイマー


  // ---- こねロジック ----
  let kneadProgress = 0; // 0..100
  let dough = {
    cx: canvas.width/2,
    cy: canvas.height/2+10,
    r: 150,
    wobble: 0, // 変形量
    vx: 0
  };

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // 作業台
    ctx.fillStyle = '#f2e5cf';
    ctx.fillRect(0, canvas.height-120, canvas.width, 120);
    ctx.fillStyle = '#e8d9bd';
    for(let x=0; x<canvas.width; x+=24){
      ctx.fillRect(x, canvas.height-120, 12, 120);
    }

    // 棚
    ctx.save();
    ctx.translate(dough.cx, dough.cy-120);
    ctx.fillStyle = '#d8b385';
    ctx.fillRect(-220,250,440,28);
    ctx.restore();

    // 生地（むにゅ）
    const squash = Math.max(0.7, 1 - dough.wobble*0.015);
    const stretch = Math.min(1.4, 1 + dough.wobble*0.02);
    ctx.save();
    ctx.translate(dough.cx, dough.cy);
    ctx.scale(stretch, squash);
    const grd = ctx.createRadialGradient(0, -40, 30, 0, 0, dough.r+40);
    grd.addColorStop(0, '#fff6d9');
    grd.addColorStop(1, '#efd9a6');
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.arc(0,0,dough.r,0,Math.PI*2);
    ctx.fill();
    ctx.restore();

    // テキスト
    ctx.fillStyle = '#2b2b2b';
    ctx.font = '18px system-ui, sans-serif';
    ctx.fillText('ドラッグ／スワイプで「こねる」→ ゲージ100%で うどん玉 完成！', 18, 30);
    ctx.fillText('手を離すと生地が戻るよ。', 18, 56);
  }

  // 物理の更新
  function updatePhysics(dt){
    // ゆっくり中央に戻る
    dough.vx += (-dough.wobble) * 10 * dt;
    dough.vx *= 0.92;
    dough.wobble += dough.vx * dt;
    dough.wobble = Math.max(-10, Math.min(10, dough.wobble));
  }

// 入力
let dragging = false;
let lastX = 0;

function onPointerDown(e){
  if(isLocked()) return;
  dragging = true;
  const p = getPos(e);
  lastX = p.x;

  // クリック後に少し待ってから やさしくぷにっ
  if (tapTimeout) { clearTimeout(tapTimeout); tapTimeout = null; }
  tapTimeout = setTimeout(() => {
    const s = Math.random() < 0.5 ? -1 : 1;
    dough.vx     -= 3;       // ← 弱めに
    dough.wobble += 1.0 * s; // ← 弱めに
    dough.wobble = Math.max(-10, Math.min(10, dough.wobble));
    tapTimeout = null;
  }, TAP_DELAY_MS);
}

  function onPointerMove(e){
    if(!dragging) return;
    const p = getPos(e);
    const dx = p.x - lastX;
    lastX = p.x;

    // 左右の往復で「こね力」加算
    const add = Math.min(1.5, Math.abs(dx) * 0.12);
    kneadProgress = Math.min(100, kneadProgress + add);

    // 生地の変形
    dough.wobble += Math.sign(dx) * 1.2;
  }
  function onPointerUp(){
    dragging = false;
  dough.vx += 3;      // ちょい戻す
    dough.wobble *= 0.9; // 揺れを少し整える（暴れ防止）
  }
  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  }

  canvas.addEventListener('mousedown', onPointerDown);
  canvas.addEventListener('mousemove', onPointerMove);
  window.addEventListener('mouseup', onPointerUp);
  canvas.addEventListener('touchstart', onPointerDown, {passive:true});
  canvas.addEventListener('touchmove', onPointerMove, {passive:true});
  window.addEventListener('touchend', onPointerUp);

  // ゲームループ
  let lastFrame = performance.now();
  function loop(t){
    // 経過時間でプレイ時間加算＆ロック判定
    accruePlaytime();

    const dt = Math.min(0.05, (t - lastFrame)/1000);
    lastFrame = t;

    // 物理更新と描画
    updatePhysics(dt);
    draw();

    // こね進捗が満タンなら玉カウント
    if(kneadProgress >= 100){
      bowlCount += 1;
      localStorage.setItem(KEY.bowls, bowlCount);
      kneadProgress = 0;
      // 小さな演出：ポンっと跳ねる
      dough.vx -= 20;
    }

    // UI更新
    const leftSec = Math.max(0, DAILY_LIMIT_SEC - usedSec);
    elTimeLeft.textContent = fmtHMS(leftSec);
    elJstDate.textContent = todayJstStr();
    elBowl.textContent = bowlCount;
    elKneadBar.style.width = `${kneadProgress}%`;
    elPlayBar.style.width = `${(usedSec/DAILY_LIMIT_SEC)*100}%`;

    // ロック表示
    const locked = isLocked();
    elLock.style.display = locked ? 'flex' : 'none';
    if(locked){
      elUntil.textContent = fmtHMS(secondsUntilNextJstMidnight());
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

// タブ非表示↔表示でも実時間差分を正しくカウント
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    // 隠れた時刻を保存（参照用）
    localStorage.setItem(KEY.lastStamp, Date.now());
  } else {
    // 目視可能に戻ったら、隠れていた間の経過秒をまとめて加算
    const prev = Number(localStorage.getItem(KEY.lastStamp) || Date.now());
    const now  = Date.now();
    const deltaSec = Math.max(0, Math.floor((now - prev) / 1000));

    // 日付跨ぎにも対応（JST判定）
    dailyRolloverCheck();

    if (!isLocked()) {
      usedSec = Math.min(DAILY_LIMIT_SEC, usedSec + deltaSec);
    }

    lastStamp = now;
    localStorage.setItem(KEY.usedSec, usedSec);
    localStorage.setItem(KEY.lastStamp, lastStamp);
    localStorage.setItem(KEY.jstDate, savedDate);
  }
});

  // ボタン
  btnReset.addEventListener('click', ()=>{
    if(isLocked()) return;
    kneadProgress = 0;
  });
  btnHowTo.addEventListener('click', ()=>{
    alert([
      '【遊び方】',
      '・マウス/指で左右にゴシゴシこねるとゲージUP。',
      '・100%で「うどん玉」完成！通算カウントに加算。',
      '・今日のプレイは1時間まで（日本時間で日付リセット）。',
      '・ズル対策で実時間差分でカウント。タブ放置でも時間は進みます。',
      '・セーブは端末ごと（localStorage）。'
    ].join('\n'));
  });
  btnWipe.addEventListener('click', ()=>{
    if(confirm('セーブデータを全削除しますか？（本日の残り時間も初期化されます）')){
      localStorage.removeItem(KEY.usedSec);
      localStorage.removeItem(KEY.jstDate);
      localStorage.removeItem(KEY.lastStamp);
      localStorage.removeItem(KEY.bowls);
      usedSec=0; savedDate=todayJstStr(); lastStamp=Date.now(); bowlCount=0; kneadProgress=0;
      localStorage.setItem(KEY.jstDate, savedDate);
      alert('削除しました。');
    }
  });

  // 初期反映
  elBowl.textContent = bowlCount;
  elJstDate.textContent = savedDate;
})();
</script>
</body>
</html>
