<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã†ã©ã‚“ã“ã­ã‚‹ã‚²ãƒ¼ãƒ </title>
  <link rel="icon" href="favicon.ico">
<style>
  :root { --bg:#fffaf3; --ink:#2b2b2b; --accent:#ffb703; --accent2:#8ecae6; --good:#2a9d8f; --warn:#e76f51; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic UI","Noto Sans JP","Noto Sans CJK JP",sans-serif}
  header{padding:14px 16px;border-bottom:1px dashed #00000020;background:#fff;position:sticky;top:0;z-index:2}
  h1{margin:0;font-size:20px}
  .wrap{max-width:900px;margin:0 auto;padding:14px}
  .stats{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .badge{padding:6px 10px;border-radius:999px;background:#00000008}
  .timer{font-variant-numeric:tabular-nums}
  .bar{height:14px;background:#00000010;border-radius:999px;overflow:hidden;box-shadow:inset 0 0 0 1px #00000010}
  .bar > div{height:100%;width:0}
  .bar .play{background:linear-gradient(90deg,var(--accent2),#90ee90)}
  .bar .knead{background:linear-gradient(90deg,var(--accent),#ffd166)}
  .row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:10px;border:1px solid #00000020;background:#fff;cursor:pointer}
  button.primary{background:var(--good);color:#fff;border:none}
  button.warn{background:var(--warn);color:#fff;border:none}
  canvas{background:radial-gradient(circle at 50% 40%, #fff 0%, #fff 40%, #fff8 60%, #0000 61%), #f7eddc; border-radius:18px; box-shadow: inset 0 10px 30px #00000010, 0 8px 24px #00000010; touch-action:none}
  .lock{padding:14px;border:2px dashed #00000020;border-radius:12px;background:#ffffffb8;backdrop-filter:saturate(120%) blur(2px)}
  footer{opacity:.7;text-align:center;padding:18px 0}
  .small{font-size:12px}
</style>
</head>
<body>
<header>
  <h1>ã†ã©ã‚“ã“ã­ã‚‹ã‚²ãƒ¼ãƒ ï¼ˆ1æ—¥1æ™‚é–“ï¼‰</h1>
</header>

<div class="wrap">
  <section class="stats" aria-live="polite">
    <div class="badge">ä»Šæ—¥ã®æ®‹ã‚Šæ™‚é–“ï¼š<span id="timeLeft" class="timer">--:--:--</span></div>
    <div class="badge">ä»Šæ—¥ã®æ—¥ä»˜ï¼ˆJSTï¼‰ï¼š<span id="jstDate">--</span></div>
    <div class="badge">é€šç®—ã†ã©ã‚“ç‰ï¼š<span id="bowlCount">0</span> ç‰</div>
  </section>

  <hr />

  <section>
    <div class="row" style="margin:10px 0 6px">
      <div>ã“ã­é€²æ—</div>
      <div class="bar" aria-label="ã“ã­é€²æ—">
        <div id="kneadBar" class="knead" style="width:0%"></div>
      </div>
    </div>
    <div class="row" style="margin:6px 0 18px">
      <div>ä»Šæ—¥ã®ãƒ—ãƒ¬ã‚¤</div>
      <div class="bar" aria-label="ä»Šæ—¥ã®ãƒ—ãƒ¬ã‚¤æ™‚é–“">
        <div id="playBar" class="play" style="width:0%"></div>
      </div>
    </div>

    <div class="controls">
      <button id="resetKnead" title="ä»Šã®ç”Ÿåœ°ã‚’æ¨ã¦ã¦ã‚„ã‚Šç›´ã—">ç”Ÿåœ°ã‚’æ¨ã¦ã‚‹</button>
      <button id="howTo">éŠã³æ–¹</button>
      <button id="wipe" class="warn" title="ã‚»ãƒ¼ãƒ–å…¨éƒ¨å‰Šé™¤ï¼ˆåˆ¶é™ã‚‚æ¶ˆãˆã¾ã™ï¼‰">ã‚»ãƒ¼ãƒ–å‰Šé™¤</button>
    </div>
  </section>

  <section style="margin:16px 0">
    <div style="position:relative">
      <canvas id="stage" width="900" height="520" aria-label="ã†ã©ã‚“ç”Ÿåœ°ã‚­ãƒ£ãƒ³ãƒã‚¹"></canvas>
      <div id="lock" class="lock" style="display:none; position:absolute; inset:12px; display:flex; align-items:center; justify-content:center; text-align:center">
        <div>
          <h2>æœ¬æ—¥ã®æŒã¡æ™‚é–“ã¯çµ‚äº†ï¼</h2>
          <p class="timer">æ¬¡ã®è§£ç¦ï¼ˆJST 0:00ï¼‰ã¾ã§ <span id="untilReset">--:--:--</span></p>
          <p class="small">â€»ã“ã®åˆ¶é™ã¯ç«¯æœ«ã”ã¨ã§ã™ã€‚ä¼šç¤¾ã®ç«¯æœ«ã§ã®ãƒ—ãƒ¬ã‚¤ã¯ãŠã™ã™ã‚ã—ã¾ã›ã‚“ğŸœ</p>
        </div>
      </div>
    </div>
  </section>

  <footer class="small">Â© ã‚ãªãŸã®ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Œçµã€‚BGMãªã—ãƒ»åŠ¹æœéŸ³ãªã—ï¼ˆé™ã‹ã«ã“ã­ãŸã„æ–¹å‘ã‘ï¼‰ã€‚</footer>
</div>

<script>
(function(){
  // ---- è¨­å®š ----
  const DAILY_LIMIT_SEC = 60 * 60; // 1æ™‚é–“
  const JST_OFFSET_MS = 9 * 60 * 60 * 1000; // UTC+9 å›ºå®šï¼ˆJSTã¯DSTãªã—ï¼‰

  const TAP_DELAY_MS = 120; // ã‚¯ãƒªãƒƒã‚¯å¾Œã®å¾…ã¡æ™‚é–“ï¼ˆmsï¼‰//ã‚¿ãƒƒãƒ—ãƒ—ãƒ‹ã®æ™‚é–“

  // ---- ä¿å­˜ã‚­ãƒ¼ ----
  const KEY = {
    usedSec: 'udon_used_seconds',
    jstDate: 'udon_date_jst',
    lastStamp: 'udon_last_epoch_ms',
    bowls: 'udon_total_bowls'
  };

  // ---- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šJSTã®ä»Š ----
  function nowJST(){ return new Date(Date.now() + JST_OFFSET_MS); }
  function todayJstStr(){
    const d = nowJST();
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,'0');
    const day = String(d.getUTCDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function secondsUntilNextJstMidnight(){
    const now = nowJST();
    const next = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()+1, 0,0,0));
    return Math.max(0, Math.floor((next - now) / 1000));
  }
  function fmtHMS(sec){
    const s = Math.max(0, Math.floor(sec));
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  }

  // ---- çŠ¶æ…‹ ----
  let usedSec = Number(localStorage.getItem(KEY.usedSec) || 0);
  let savedDate = localStorage.getItem(KEY.jstDate) || todayJstStr();
  let lastStamp = Number(localStorage.getItem(KEY.lastStamp) || Date.now());
  let bowlCount = Number(localStorage.getItem(KEY.bowls) || 0);

  // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
  function dailyRolloverCheck(){
    const today = todayJstStr();
    if(savedDate !== today){
      usedSec = 0;
      savedDate = today;
      localStorage.setItem(KEY.usedSec, usedSec);
      localStorage.setItem(KEY.jstDate, savedDate);
    }
  }
  dailyRolloverCheck();

  // å®Ÿæ™‚é–“å·®åˆ†ã§ä½¿ç”¨æ™‚é–“ã‚’åŠ ç®—
function accruePlaytime(){
  dailyRolloverCheck();
  const now = Date.now();

  if (isLocked()) {               // ãƒ­ãƒƒã‚¯ä¸­ã¯å°ã ã‘æ›´æ–°
    lastStamp = now;
    localStorage.setItem(KEY.lastStamp, lastStamp);
    return;
  }

  const elapsedMs = now - lastStamp;
  if (elapsedMs >= 1000) {
    const delta = Math.floor(elapsedMs / 1000); // çµŒéã€Œæ•´æ•°ç§’ã€
    usedSec = Math.min(DAILY_LIMIT_SEC, usedSec + delta);
    lastStamp += delta * 1000;    // ç«¯æ•°msã‚’æ¬¡å›ã«ç¹°ã‚Šè¶Šã™ï¼ˆâ†ã“ã“ãŒå¤§äº‹ï¼‰
    localStorage.setItem(KEY.usedSec, usedSec);
    localStorage.setItem(KEY.lastStamp, lastStamp);
  }
}


  function isLocked(){ return usedSec >= DAILY_LIMIT_SEC; }

  // ---- UIå‚ç…§ ----
  const elTimeLeft = document.getElementById('timeLeft');
  const elJstDate  = document.getElementById('jstDate');
  const elBowl     = document.getElementById('bowlCount');
  const elKneadBar = document.getElementById('kneadBar');
  const elPlayBar  = document.getElementById('playBar');
  const elLock     = document.getElementById('lock');
  const elUntil    = document.getElementById('untilReset');
  const btnReset   = document.getElementById('resetKnead');
  const btnHowTo   = document.getElementById('howTo');
  const btnWipe    = document.getElementById('wipe');
  const canvas     = document.getElementById('stage');
  const ctx = canvas.getContext('2d');

  let tapTimeout = null; // ã‚¯ãƒªãƒƒã‚¯é…å»¶ã‚¿ã‚¤ãƒãƒ¼


  // ---- ã“ã­ãƒ­ã‚¸ãƒƒã‚¯ ----
  let kneadProgress = 0; // 0..100
  let dough = {
    cx: canvas.width/2,
    cy: canvas.height/2+10,
    r: 150,
    wobble: 0, // å¤‰å½¢é‡
    vx: 0
  };

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // ä½œæ¥­å°
    ctx.fillStyle = '#f2e5cf';
    ctx.fillRect(0, canvas.height-120, canvas.width, 120);
    ctx.fillStyle = '#e8d9bd';
    for(let x=0; x<canvas.width; x+=24){
      ctx.fillRect(x, canvas.height-120, 12, 120);
    }

    // æ£š
    ctx.save();
    ctx.translate(dough.cx, dough.cy-120);
    ctx.fillStyle = '#d8b385';
    ctx.fillRect(-220,250,440,28);
    ctx.restore();

    // ç”Ÿåœ°ï¼ˆã‚€ã«ã‚…ï¼‰
    const squash = Math.max(0.7, 1 - dough.wobble*0.015);
    const stretch = Math.min(1.4, 1 + dough.wobble*0.02);
    ctx.save();
    ctx.translate(dough.cx, dough.cy);
    ctx.scale(stretch, squash);
    const grd = ctx.createRadialGradient(0, -40, 30, 0, 0, dough.r+40);
    grd.addColorStop(0, '#fff6d9');
    grd.addColorStop(1, '#efd9a6');
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.arc(0,0,dough.r,0,Math.PI*2);
    ctx.fill();
    ctx.restore();

    // ãƒ†ã‚­ã‚¹ãƒˆ
    ctx.fillStyle = '#2b2b2b';
    ctx.font = '18px system-ui, sans-serif';
    ctx.fillText('ãƒ‰ãƒ©ãƒƒã‚°ï¼ã‚¹ãƒ¯ã‚¤ãƒ—ã§ã€Œã“ã­ã‚‹ã€â†’ ã‚²ãƒ¼ã‚¸100%ã§ ã†ã©ã‚“ç‰ å®Œæˆï¼', 18, 30);
    ctx.fillText('æ‰‹ã‚’é›¢ã™ã¨ç”Ÿåœ°ãŒæˆ»ã‚‹ã‚ˆã€‚', 18, 56);
  }

  // ç‰©ç†ã®æ›´æ–°
  function updatePhysics(dt){
    // ã‚†ã£ãã‚Šä¸­å¤®ã«æˆ»ã‚‹
    dough.vx += (-dough.wobble) * 10 * dt;
    dough.vx *= 0.92;
    dough.wobble += dough.vx * dt;
    dough.wobble = Math.max(-10, Math.min(10, dough.wobble));
  }

// å…¥åŠ›
let dragging = false;
let lastX = 0;

function onPointerDown(e){
  if(isLocked()) return;
  dragging = true;
  const p = getPos(e);
  lastX = p.x;

  // ã‚¯ãƒªãƒƒã‚¯å¾Œã«å°‘ã—å¾…ã£ã¦ã‹ã‚‰ ã‚„ã•ã—ãã·ã«ã£
  if (tapTimeout) { clearTimeout(tapTimeout); tapTimeout = null; }
  tapTimeout = setTimeout(() => {
    const s = Math.random() < 0.5 ? -1 : 1;
    dough.vx     -= 3;       // â† å¼±ã‚ã«
    dough.wobble += 1.0 * s; // â† å¼±ã‚ã«
    dough.wobble = Math.max(-10, Math.min(10, dough.wobble));
    tapTimeout = null;
  }, TAP_DELAY_MS);
}

  function onPointerMove(e){
    if(!dragging) return;
    const p = getPos(e);
    const dx = p.x - lastX;
    lastX = p.x;

    // å·¦å³ã®å¾€å¾©ã§ã€Œã“ã­åŠ›ã€åŠ ç®—
    const add = Math.min(1.5, Math.abs(dx) * 0.12);
    kneadProgress = Math.min(100, kneadProgress + add);

    // ç”Ÿåœ°ã®å¤‰å½¢
    dough.wobble += Math.sign(dx) * 1.2;
  }
  function onPointerUp(){
    dragging = false;
  dough.vx += 3;      // ã¡ã‚‡ã„æˆ»ã™
    dough.wobble *= 0.9; // æºã‚Œã‚’å°‘ã—æ•´ãˆã‚‹ï¼ˆæš´ã‚Œé˜²æ­¢ï¼‰
  }
  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return { x: clientX - rect.left, y: clientY - rect.top };
  }

  canvas.addEventListener('mousedown', onPointerDown);
  canvas.addEventListener('mousemove', onPointerMove);
  window.addEventListener('mouseup', onPointerUp);
  canvas.addEventListener('touchstart', onPointerDown, {passive:true});
  canvas.addEventListener('touchmove', onPointerMove, {passive:true});
  window.addEventListener('touchend', onPointerUp);

  // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
  let lastFrame = performance.now();
  function loop(t){
    // çµŒéæ™‚é–“ã§ãƒ—ãƒ¬ã‚¤æ™‚é–“åŠ ç®—ï¼†ãƒ­ãƒƒã‚¯åˆ¤å®š
    accruePlaytime();

    const dt = Math.min(0.05, (t - lastFrame)/1000);
    lastFrame = t;

    // ç‰©ç†æ›´æ–°ã¨æç”»
    updatePhysics(dt);
    draw();

    // ã“ã­é€²æ—ãŒæº€ã‚¿ãƒ³ãªã‚‰ç‰ã‚«ã‚¦ãƒ³ãƒˆ
    if(kneadProgress >= 100){
      bowlCount += 1;
      localStorage.setItem(KEY.bowls, bowlCount);
      kneadProgress = 0;
      // å°ã•ãªæ¼”å‡ºï¼šãƒãƒ³ã£ã¨è·³ã­ã‚‹
      dough.vx -= 20;
    }

    // UIæ›´æ–°
    const leftSec = Math.max(0, DAILY_LIMIT_SEC - usedSec);
    elTimeLeft.textContent = fmtHMS(leftSec);
    elJstDate.textContent = todayJstStr();
    elBowl.textContent = bowlCount;
    elKneadBar.style.width = `${kneadProgress}%`;
    elPlayBar.style.width = `${(usedSec/DAILY_LIMIT_SEC)*100}%`;

    // ãƒ­ãƒƒã‚¯è¡¨ç¤º
    const locked = isLocked();
    elLock.style.display = locked ? 'flex' : 'none';
    if(locked){
      elUntil.textContent = fmtHMS(secondsUntilNextJstMidnight());
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

// ã‚¿ãƒ–éè¡¨ç¤ºâ†”è¡¨ç¤ºã§ã‚‚å®Ÿæ™‚é–“å·®åˆ†ã‚’æ­£ã—ãã‚«ã‚¦ãƒ³ãƒˆ
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    // éš ã‚ŒãŸæ™‚åˆ»ã‚’ä¿å­˜ï¼ˆå‚ç…§ç”¨ï¼‰
    localStorage.setItem(KEY.lastStamp, Date.now());
  } else {
    // ç›®è¦–å¯èƒ½ã«æˆ»ã£ãŸã‚‰ã€éš ã‚Œã¦ã„ãŸé–“ã®çµŒéç§’ã‚’ã¾ã¨ã‚ã¦åŠ ç®—
    const prev = Number(localStorage.getItem(KEY.lastStamp) || Date.now());
    const now  = Date.now();
    const deltaSec = Math.max(0, Math.floor((now - prev) / 1000));

    // æ—¥ä»˜è·¨ãã«ã‚‚å¯¾å¿œï¼ˆJSTåˆ¤å®šï¼‰
    dailyRolloverCheck();

    if (!isLocked()) {
      usedSec = Math.min(DAILY_LIMIT_SEC, usedSec + deltaSec);
    }

    lastStamp = now;
    localStorage.setItem(KEY.usedSec, usedSec);
    localStorage.setItem(KEY.lastStamp, lastStamp);
    localStorage.setItem(KEY.jstDate, savedDate);
  }
});

  // ãƒœã‚¿ãƒ³
  btnReset.addEventListener('click', ()=>{
    if(isLocked()) return;
    kneadProgress = 0;
  });
  btnHowTo.addEventListener('click', ()=>{
    alert([
      'ã€éŠã³æ–¹ã€‘',
      'ãƒ»ãƒã‚¦ã‚¹/æŒ‡ã§å·¦å³ã«ã‚´ã‚·ã‚´ã‚·ã“ã­ã‚‹ã¨ã‚²ãƒ¼ã‚¸UPã€‚',
      'ãƒ»100%ã§ã€Œã†ã©ã‚“ç‰ã€å®Œæˆï¼é€šç®—ã‚«ã‚¦ãƒ³ãƒˆã«åŠ ç®—ã€‚',
      'ãƒ»ä»Šæ—¥ã®ãƒ—ãƒ¬ã‚¤ã¯1æ™‚é–“ã¾ã§ï¼ˆæ—¥æœ¬æ™‚é–“ã§æ—¥ä»˜ãƒªã‚»ãƒƒãƒˆï¼‰ã€‚',
      'ãƒ»ã‚ºãƒ«å¯¾ç­–ã§å®Ÿæ™‚é–“å·®åˆ†ã§ã‚«ã‚¦ãƒ³ãƒˆã€‚ã‚¿ãƒ–æ”¾ç½®ã§ã‚‚æ™‚é–“ã¯é€²ã¿ã¾ã™ã€‚',
      'ãƒ»ã‚»ãƒ¼ãƒ–ã¯ç«¯æœ«ã”ã¨ï¼ˆlocalStorageï¼‰ã€‚'
    ].join('\n'));
  });
  btnWipe.addEventListener('click', ()=>{
    if(confirm('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆæœ¬æ—¥ã®æ®‹ã‚Šæ™‚é–“ã‚‚åˆæœŸåŒ–ã•ã‚Œã¾ã™ï¼‰')){
      localStorage.removeItem(KEY.usedSec);
      localStorage.removeItem(KEY.jstDate);
      localStorage.removeItem(KEY.lastStamp);
      localStorage.removeItem(KEY.bowls);
      usedSec=0; savedDate=todayJstStr(); lastStamp=Date.now(); bowlCount=0; kneadProgress=0;
      localStorage.setItem(KEY.jstDate, savedDate);
      alert('å‰Šé™¤ã—ã¾ã—ãŸã€‚');
    }
  });

  // åˆæœŸåæ˜ 
  elBowl.textContent = bowlCount;
  elJstDate.textContent = savedDate;
})();
</script>
</body>
</html>
